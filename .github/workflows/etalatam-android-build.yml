name: ETAlatam Android Build

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'release/**'
  pull_request:
    branches:
      - main
      - master
      - develop

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  android-build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ETAlatam Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: ðŸ“¦ Install Dependencies
        run: |
          flutter --version
          flutter pub get

      - name: ðŸ“ Configure ETAlatam Environment
        run: |
          # Create environment configuration if needed
          if [ ! -f android/app/google-services.json ]; then
            echo "âš ï¸ Warning: google-services.json not found"
          fi

      - name: ðŸ”‘ Setup Android Signing (Optional)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        env:
          ETALATAM_KEYSTORE_BASE64: ${{ secrets.ETALATAM_ANDROID_KEYSTORE_BASE64 }}
          ETALATAM_KEYSTORE_PASSWORD: ${{ secrets.ETALATAM_ANDROID_KEYSTORE_PASSWORD }}
          ETALATAM_KEY_ALIAS: ${{ secrets.ETALATAM_ANDROID_KEY_ALIAS }}
          ETALATAM_KEY_PASSWORD: ${{ secrets.ETALATAM_ANDROID_KEY_PASSWORD }}
        run: |
          if [ ! -z "$ETALATAM_KEYSTORE_BASE64" ]; then
            echo "$ETALATAM_KEYSTORE_BASE64" | base64 --decode > android/app/etalatam-keystore.jks
            echo "storePassword=$ETALATAM_KEYSTORE_PASSWORD" >> android/key.properties
            echo "keyPassword=$ETALATAM_KEY_PASSWORD" >> android/key.properties
            echo "keyAlias=$ETALATAM_KEY_ALIAS" >> android/key.properties
            echo "storeFile=etalatam-keystore.jks" >> android/key.properties
            echo "âœ… ETAlatam signing configured"
          else
            echo "âš ï¸ Building unsigned APK (no keystore configured)"
          fi

      - name: ðŸ—ï¸ Build ETAlatam APK
        run: |
          flutter build apk --release --split-per-abi

      - name: ðŸ“Š Display Build Info
        run: |
          echo "=== ETAlatam Build Information ==="
          echo "Build Number: ${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Flutter Version: $(flutter --version | head -1)"
          echo ""
          echo "=== APK Files Generated ==="
          ls -lh build/app/outputs/flutter-apk/*.apk

      - name: ðŸ“¤ Upload ETAlatam ARM64 APK
        uses: actions/upload-artifact@v4
        with:
          name: etalatam-arm64-v8a-apk
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          retention-days: 30

      - name: ðŸ“¤ Upload ETAlatam ARMv7 APK
        uses: actions/upload-artifact@v4
        with:
          name: etalatam-armeabi-v7a-apk
          path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          retention-days: 30

      - name: ðŸ“¤ Upload ETAlatam x86_64 APK
        uses: actions/upload-artifact@v4
        if: hashFiles('build/app/outputs/flutter-apk/app-x86_64-release.apk') != ''
        with:
          name: etalatam-x86_64-apk
          path: build/app/outputs/flutter-apk/app-x86_64-release.apk
          retention-days: 30

      - name: ðŸ’¬ Comment on PR with APK Links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸŽ‰ ETAlatam Android Build Successful!\n\n` +
                    `### ðŸ“¦ Download APKs:\n` +
                    `- [ARM64 APK](${artifactUrl})\n` +
                    `- [ARMv7 APK](${artifactUrl})\n\n` +
                    `**Build #**: ${{ github.run_number }}\n` +
                    `**Commit**: \`${{ github.sha }}\`\n` +
                    `**Flutter**: ${{ env.FLUTTER_VERSION }}`
            })

      - name: ðŸŽ¯ Build Summary
        if: always()
        run: |
          echo "## ETAlatam Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Number | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Flutter Version | ${{ env.FLUTTER_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Java Version | ${{ env.JAVA_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build/app/outputs/flutter-apk/app-arm64-v8a-release.apk ]; then
            echo "### âœ… APKs Generated Successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
          fi